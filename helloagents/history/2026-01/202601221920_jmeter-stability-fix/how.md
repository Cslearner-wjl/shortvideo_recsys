# 技术设计: JMeter 压测稳定性修复（死锁重试 + 压测模型修正）

## 技术方案

### 核心问题定位（基于报告与复现）
1. **发评 500**：后端日志出现 `DeadlockLoserDataAccessException`，SQL 指向 `UPDATE video_stats SET comment_count = comment_count + 1 WHERE video_id = ?`。
2. **摸高/浸泡模型偏差**：`peak/soak` 使用的 JMX 在循环运行时反复执行登录与预热，导致压测压力被“非业务动作”放大，结果失真。

### 实现要点
1. **事务级重试（后端）**
   - 对互动写链路（尤其 `comment`）引入“可重试的事务执行器”。
   - 捕获典型并发冲突异常（如 `DeadlockLoserDataAccessException`/`CannotAcquireLockException` 等）后执行有限次重试。
   - 使用指数退避 + 抖动避免惊群重试。
   - 重试粒度为“整个事务”，确保回滚后再重试，避免部分写入导致数据不一致。

2. **压测计划修正（JMeter）**
   - 为 peak/soak 新增独立 JMX：将“登录 + 视频ID抽样”放到循环之外，仅业务动作进入循环控制器。
   - 调整视频 ID 获取策略：从 `/api/videos/page` 返回列表中随机选取，避免所有线程写同一视频造成不真实的热点锁冲突。

3. **稳定性标准（压测验收口径，落地到报告）**
   - **混合场景（阶段一）**：整体错误率 < 1%，关键写接口（发评/点赞）错误率 < 1%，无持续性 500。
   - **摸高（阶段二）**：按阶梯加压寻找最大稳定并发（p95 <= 500ms 且错误率 < 1%）。
   - **浸泡（阶段三）**：以峰值并发 70% 运行 30+ 分钟，错误率 < 1%，响应时间无明显随时间劣化。

## 架构决策 ADR

### ADR-001: 以事务重试处理死锁（采纳）
**上下文:** 写热点或多表写入在高并发下可能出现 InnoDB 死锁；直接返回 500 会导致压测与线上体验不稳定。  
**决策:** 对写链路采用有限次事务级重试 + 退避抖动。  
**理由:** 侵入性低、实现成本低、符合数据库并发冲突的常见处理方式。  
**替代方案:** 调整锁顺序/拆分事务/异步统计 → 拒绝原因: 改动范围更大且需要额外一致性设计。  
**影响:** 极端并发下尾延迟可能上升，但整体错误率显著下降。

## 安全与性能
- **安全:** 凭据仍通过环境变量注入，不落盘；压测报告不记录明文密码。
- **性能:** 避免无意义的循环登录/预热；降低热点写冲突；事务重试采用上限与退避避免放大压力。

## 测试与部署
- **测试:** 三阶段 JMeter 复测 + 日志核验（无大量死锁/500）；必要时补充后端并发回归测试。
- **部署:** 无需额外基础设施变更；后端重启后即可验证。

