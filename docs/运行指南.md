# 运行指南

> 本文档汇总仓库常用启动与运行命令，便于快速检索。

## 快速入口
- **依赖启动（Docker Compose）**：见“启动依赖”章节
- **后端启动**：见“启动后端”章节
- **前端启动**：见“启动前端”章节
- **常见问题排查**：见“常见问题排查”章节

---

## 先决条件
- Windows 11 + WSL2 + Docker Desktop（WSL2 后端）
- Java 17 + Maven
- Node.js 20 + npm

---

## 启动依赖（MySQL/Redis/MinIO/Kafka/HDFS）
在仓库根目录执行：

1) 复制环境变量文件（PowerShell）：

```bash
Copy-Item -Force "deploy\.env.example" "deploy\.env"
```

2) 启动依赖：

```bash
docker compose --env-file "deploy\.env" -f "deploy\docker-compose.yml" up -d
docker compose --env-file "deploy\.env" -f "deploy\docker-compose.yml" ps
```

3) 快速验证（可选）：

- MinIO Console：`http://localhost:9001`
- Redis：
  ```bash
  redis-cli -h 127.0.0.1 -p 6379 ping
  ```
- Kafka（在容器内创建 Topic 示例）：
  ```bash
  docker exec -it shortvideo-recsys-kafka bash -lc "kafka-topics.sh --bootstrap-server localhost:9092 --create --if-not-exists --topic demo_events --partitions 1 --replication-factor 1"
  ```
- HDFS（可选）：
  - NameNode UI：`http://localhost:9870`
  - HDFS 路径检查：
    ```bash
    docker exec -it shortvideo-recsys-namenode bash -lc "hdfs dfs -ls /"
    ```

停止：
```bash
docker compose --env-file "deploy\.env" -f "deploy\docker-compose.yml" down
```

---

## 启动后端（健康检查）

```bash
cd backend
mvn test
mvn spring-boot:run
```

健康检查：

```bash
curl http://localhost:8080/api/health
curl http://localhost:8080/actuator/health
```

如需与 docker compose 联动（预留 datasource 配置）：

```bash
mvn spring-boot:run -Dspring-boot.run.profiles=docker
```

---

## 启动前端（用户端/管理端）

用户端：
```bash
cd frontend/user
npm install
npm run dev
```

管理端：
```bash
cd frontend/admin
npm install
npm run dev
```

构建验证：
```bash
cd frontend\user
npm run build
cd ..\admin
npm run build
```

收集视频脚本：
```bash
./scripts/crawl_and_import.sh \
  --source pixabay \
  --api-key 54294108-0892189436b8a034189c08942 \
  --query "funny" \
  --count 20 \
  --admin-pass AdminPass123

  ./scripts/crawl_and_import.sh \
  --source pexels \
  --api-key LPClu0Hcx9YDZlymfqHlK3NbUoBR8wtUwdHNbznq2pk4AuJ7h3tIU7UP \
  --query "funny" \
  --count 20 \
  --admin-pass AdminPass123
```

redis：

  # 进入交互模式
  docker exec -it shortvideo-recsys-redis redis-cli
  # 查看所有键
  docker exec shortvideo-recsys-redis redis-cli KEYS '*'
  # 查看热榜 Top10（按分数降序）
  docker exec shortvideo-recsys-redis redis-cli ZREVRANGE hot:videos 0 9 WITHSCORES
  # 查看某个视频的统计数据
  docker exec shortvideo-recsys-redis redis-cli HGETALL stats:video:54
  # 查看 ALS 推荐结果
  docker exec shortvideo-recsys-redis redis-cli LRANGE rec:user:1 0 -1

kafka（behavior-events Topic，包含用户播放/点赞等行为事件）：

  # 查看所有 Topic
  docker exec shortvideo-recsys-kafka kafka-topics --bootstrap-server localhost:9092 --list
  # 查看 behavior-events 消息（从头开始，最多10条）
  docker exec shortvideo-recsys-kafka kafka-console-consumer \
    --bootstrap-server localhost:9092 \
    --topic behavior-events \
    --from-beginning \
    --max-messages 10
  # 实时监听新消息
  docker exec shortvideo-recsys-kafka kafka-console-consumer \
    --bootstrap-server localhost:9092 \
    --topic behavior-events
  # 查看 Topic 详情
  docker exec shortvideo-recsys-kafka kafka-topics \
    --bootstrap-server localhost:9092 \
    --describe --topic behavior-events

Flume（监听行为日志文件并转发到 Kafka）：

  # 查看 Flume 容器日志
  docker logs shortvideo-recsys-flume --tail 50
  # 查看 Flume 读取的行为日志文件
  cat deploy/data/behavior/behavior-events.log | tail -10

  # 如启用 Kafka -> HDFS 落地，建议先准备 Spark Hadoop 客户端依赖（供 Flume HDFS Sink 复用）
  bash bigdata/streaming/bin/ensure_spark.sh

spark：

  bash scripts/run_m3_2_streaming.sh # 实时热榜
  bash scripts/run_m4_als_batch.sh  # 批处理（ALS 推荐）


完整大数据分析模式：
```bash
# 1. 启动 Docker 依赖
docker compose -f deploy/docker-compose.yml up -d
# 2. 启动后端
cd backend && nohup mvn spring-boot:run ... > /tmp/backend.log 2>&1 &
# 3. 启动流式任务（实时热榜）
nohup bash scripts/run_m3_2_streaming.sh > /tmp/streaming.log 2>&1 &
# 4. 定时运行批处理（ALS 推荐）
bash scripts/run_m4_als_batch.sh
```
---

## 常见问题排查

1) **端口冲突**
- MySQL：3306，Redis：6379，MinIO：9000/9001，Kafka：9093，HDFS：9870/8020/9864
- 修改 `deploy/.env` 后重新 `docker compose up -d`

2) **Kafka 连接不上（advertised listeners）**
- 本地客户端默认使用 `localhost:9093`
- 容器内服务互联使用 `kafka:9092`

3) **Docker Desktop / WSL2**
- 确认 Docker Desktop 已开启并启用 WSL2 集成
- 若拉取镜像慢，考虑配置镜像加速或重试

4) **MySQL 连接报错：Public Key Retrieval is not allowed**
- 已在后端 `docker` profile 的 JDBC URL 中加入 `allowPublicKeyRetrieval=true`
- 如仍失败，检查你是否修改了 MySQL 认证插件/账号密码，或是否启用了 SSL 强制策略

5) **Maven / npm 下载失败**
- 检查网络代理与证书
- Maven 可配置镜像仓库，npm 可设置 registry
