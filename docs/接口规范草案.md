# 接口规范草案（占位）

> 本文件用于 M0 阶段占位，后续在 M1 落地具体接口清单、参数与错误码，并与后端实现保持一致。

## 1. 通用约定

- **协议:** HTTP/HTTPS
- **风格:** REST + JSON
- **编码:** UTF-8
- **时间:** ISO 8601（建议）或后端统一格式（待定）

## 2. 通用响应结构（建议）

```json
{
  "code": 0,
  "message": "ok",
  "data": {}
}
```

## 3. 认证与鉴权（待定）

⚠️ 不确定因素: 当前未确定 JWT / Session / OAuth 等方案。

## 3.1 密码存储约定（已确定）

- **存储字段:** `users.password_hash`、`admin_users.password_hash`
- **算法:** bcrypt（建议 cost=12）
- **明文示例（仅文档示例，不应写入业务数据）:** `Admin123!`
- **哈希生成方式（WSL/Ubuntu 示例，无需引入项目依赖）：**

```bash
python3 - <<'PY'
import crypt
print(crypt.crypt("Admin123!", crypt.mksalt(crypt.METHOD_BLOWFISH)))
PY
```

> 迁移脚本已写入 1 条默认管理员记录（见 `backend/src/main/resources/db/migration/V2__seed_admin.sql`）。

## 4. 错误码（占位）

| code | 含义 | 说明 |
|------|------|------|
| 0 | 成功 | - |
| 40000 | 参数错误 | 校验失败 |
| 40100 | 未登录/未授权 | 需要鉴权 |
| 40300 | 无权限 | 权限不足 |
| 40301 | 账号已冻结 | 冻结后禁止登录与写操作 |
| 40901 | 用户名已存在 | 注册唯一性冲突 |
| 40902 | 邮箱已存在 | 注册唯一性冲突 |
| 40903 | 手机号已存在 | 注册唯一性冲突 |
| 40010 | 邮箱验证码无效或已过期 | 5分钟有效且单次使用 |
| 40101 | 账号或密码错误 | 登录失败统一提示 |
| 50000 | 服务内部错误 | 兜底错误 |

---

## 5. Auth 接口（M1.2）

### POST /api/auth/email-code
**描述:** 发送注册邮箱验证码（最小实现：写入表 + 控制台打印，不回传验证码）。

**请求:**
```json
{
  "email": "u1@example.com"
}
```

**响应:** `code=0`

### POST /api/auth/register
**描述:** 用户注册（用户名/手机号/邮箱/密码/邮箱验证码）。

**请求:**
```json
{
  "username": "u1",
  "phone": "13800138000",
  "email": "u1@example.com",
  "password": "Passw0rd!",
  "emailCode": "123456"
}
```

**校验:**
- 手机号必须为 11 位数字
- 邮箱格式正确且唯一
- 用户名唯一
- 邮箱验证码 5 分钟有效且单次使用

**响应:**
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "token": "BearerToken",
    "user": {
      "id": 1,
      "username": "u1",
      "phone": "13800138000",
      "email": "u1@example.com",
      "status": 1
    }
  }
}
```

### POST /api/auth/login
**描述:** 用户登录（账号：用户名/邮箱/手机号三选一 + 密码）。

**请求:**
```json
{
  "account": "u1@example.com",
  "password": "Passw0rd!"
}
```

**失败提示:** 账号不存在或密码错误统一返回 `账号或密码错误`。

### GET /api/users/me
**描述:** 获取当前用户信息（需要 JWT）。

**Header:**
- `Authorization: Bearer <token>`

---

## 6. 视频接口（M1.3）

### 管理端鉴权

- `POST/PATCH/DELETE /api/admin/**` 使用 HTTP Basic（最小实现）
- 默认管理员（由 Flyway 种子数据写入）：
  - username: `admin`
  - password: `Admin123!`

### POST /api/admin/videos
**描述:** 上传视频（multipart），落 MinIO，并写入 `videos`（`audit_status=PENDING`）。

**请求（multipart/form-data）:**
- `video`：文件（必填）
- `uploaderUserId`：上传者用户ID（必填）
- `title`：标题（必填）
- `description`：描述（可选）
- `tags`：JSON 字符串（可选）

**响应:** `data` 为视频详情（`videoUrl` 为可访问 URL）

### PATCH /api/admin/videos/{id}/audit
**描述:** 审核视频（通过/驳回）。

**请求:**
```json
{ "status": "APPROVED" }
```

### PATCH /api/admin/videos/{id}/hot
**描述:** 设置热门标记。

**请求:**
```json
{ "isHot": true }
```

### DELETE /api/admin/videos/{id}
**描述:** 删除（DB + MinIO）。

### GET /api/videos/{id}
**描述:** 用户端视频详情（仅 `APPROVED` 可见）。

### GET /api/videos/page
**描述:** 用户端分页列表（仅 `APPROVED`）。

**参数:**
- `sort`: `hot|time`
- `page`: 1..n
- `pageSize`: 1..100
