# JMeter 稳定性修复报告：评论写入死锁与压测模型修正

## 1. 背景与目标

近期压测报告显示系统在混合写场景（尤其发评）下会出现大量 500，且摸高/浸泡阶段的压测模型存在偏差（循环内重复登录/预热），导致结果失真、无法得到可信容量结论。

本次目标：
- 修复 `POST /api/videos/{id}/comments` 高并发下的稳定性问题（避免大量 500）。
- 修正 peak/soak 压测模型，使其更接近真实用户（登录一次、预热一次、循环仅业务动作）。
- 重新执行三阶段压力测试并沉淀可追溯报告，确认系统稳定。

## 2. 问题现象

### 2.1 写链路 500（发评）
在高并发 `POST /api/videos/{id}/comments` 场景中，后端出现大量 500，表现为数据库死锁相关异常。

### 2.2 压测模型失真（peak/soak）
旧的 peak/soak 压测计划在循环中反复执行登录/预热，导致：
- 非业务动作放大压力，结果不反映真实用户行为。
- 摸高与浸泡阶段的吞吐与延迟口径不可用于容量结论。

## 3. 定位证据与根因

### 3.1 数据库死锁证据（InnoDB）
通过 `SHOW ENGINE INNODB STATUS` 的 deadlock 信息可见，同一 `video_stats` 行出现 “持有 S 锁并等待升级为 X 锁” 的典型死锁模式，最终由 InnoDB 回滚其中一个事务，应用侧表现为 `DeadlockLoserDataAccessException`。

### 3.2 根因分析
根因是写链路中存在“先尝试插入 stats 行，再更新同一行统计”的模式：
- 在高并发下，重复的 `insert video_stats`（即使最终命中唯一键冲突）会触发对目标行的共享锁与锁升级路径。
- 随后同事务内的 `UPDATE video_stats SET comment_count = comment_count + 1 ...` 需要排他锁，导致并发事务间形成 S->X 互等死锁。

此外，压测早期将大量请求集中到同一 videoId（热点写），显著放大了 `video_stats` 行锁竞争，进一步加剧死锁爆发。

## 4. 修复内容（代码与压测）

### 4.1 后端修复：降低死锁概率并保证写链路稳定
- `ensureStatsRow(videoId)` 改为 “先查是否存在，不存在再插入”，避免高并发下反复尝试插入导致的锁升级死锁。
- 评论写入链路保留“事务级有限次重试 + 退避抖动”，降低极端并发下偶发锁冲突对用户体验的影响。
- 行为日志写入优化：减少压测下 I/O 与日志开销（复用 writer、将每次写入日志降为 debug、退出时关闭资源），避免对吞吐产生不必要干扰。

### 4.2 压测模型修正：peak/soak 真实化
- 新增 `tests/jmeter/backend_api_peak_soak.jmx`：每个线程仅在启动时执行一次登录与预热，循环仅包含 80/10/5/5 的业务动作。
- videoId 抽样改为从 `/api/videos/page` 返回列表中随机挑选，降低热点写冲突（更贴近真实场景的“多视频混合”）。
- `scripts/jmeter_stage2_peak.sh`、`scripts/jmeter_stage3_soak.sh` 统一使用新的 peak/soak JMX。

## 5. 复测结果（3 个阶段）

### 5.1 阶段一：混合场景（80/10/5/5）
- 结论：通过（错误率 0%）
- 报告：`docs/tests/jmeter/stage1-mix-report.md`

### 5.2 阶段二：摸高测试（阶梯加压）
- 结论：最大稳定并发 300 线程（p95 < 500ms 且错误率 < 1%）
- 报告：`docs/tests/jmeter/stage2-peak-report.md`

### 5.3 阶段三：浸泡测试（稳定性验证）
- 结论：30 分钟浸泡错误率 0%，稳定期响应时间无随时间劣化迹象；系统稳定
- 报告：`docs/tests/jmeter/stage3-soak-report.md`

## 6. 最终结论与后续建议

### 最终结论
- 评论写入链路在高并发下不再出现大量 500（死锁问题已显著收敛并在复测中未再复现）。
- 三阶段压测模型与报告均已修正并可追溯，系统稳定性结论成立。

### 后续建议
- 如需形成更强的“稳定性证明”，建议在业务稳定期后导出更细粒度的系统指标（后端 JVM heap、GC、连接池、MySQL/Redis 指标）并与 JTL 时间轴对齐。
- 若未来出现类似问题，优先检查：是否存在“插入兜底 + 同事务更新”导致的 S->X 锁升级路径，以及压测是否不小心制造了单行热点写。

