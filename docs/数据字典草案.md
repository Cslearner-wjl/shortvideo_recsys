# 数据字典草案（M1 可执行口径）

> 本文件与后端迁移脚本保持一致：`backend/src/main/resources/db/migration/*`。如有变更，以迁移脚本为准并同步更新本文件。

## 1. 表清单

- `users`：普通用户
- `admin_users`：管理员账号
- `email_verification_codes`：邮箱验证码（最小实现：写表 + 控制台打印）
- `videos`：视频元数据（含审核/热门标记）
- `video_stats`：视频聚合统计（一对一）
- `comments`：评论
- `video_likes`：点赞关系
- `video_favorites`：收藏关系
- `user_actions`：行为流水（播放/点赞/评论/收藏等）
- `daily_metrics`：日维度统计汇总（M2 看板可复用）

## 2. 表结构（摘要）

### users

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint unsigned | PK | 用户ID |
| username | varchar(64) | UNIQUE, NOT NULL | 用户名 |
| phone | varchar(32) | UNIQUE, NULL | 手机号 |
| email | varchar(128) | UNIQUE, NULL | 邮箱 |
| password_hash | varchar(100) | NOT NULL | 密码哈希（bcrypt） |
| status | tinyint | NOT NULL | 1=正常，0=冻结（约定） |
| created_at | datetime(3) | NOT NULL | 创建时间 |
| updated_at | datetime(3) | NOT NULL | 更新时间 |

索引：
- `uk_users_username` / `uk_users_phone` / `uk_users_email`
- `idx_users_created_at`

### admin_users

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint unsigned | PK | 管理员ID |
| username | varchar(64) | UNIQUE, NOT NULL | 登录名 |
| display_name | varchar(64) | NULL | 显示名 |
| password_hash | varchar(100) | NOT NULL | 密码哈希（bcrypt） |
| status | tinyint | NOT NULL | 1=正常，0=禁用（约定） |
| created_at | datetime(3) | NOT NULL | 创建时间 |
| updated_at | datetime(3) | NOT NULL | 更新时间 |

### videos

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint unsigned | PK | 视频ID |
| uploader_user_id | bigint unsigned | FK(users.id) | 上传者 |
| title | varchar(200) | NOT NULL | 标题 |
| description | text | NULL | 描述 |
| video_url | varchar(512) | NOT NULL | MinIO object key（后端返回可访问 URL） |
| cover_url | varchar(512) | NULL | 封面URL（对象存储） |
| tags | json | NULL | 标签（JSON） |
| audit_status | varchar(32) | NOT NULL | 审核状态：PENDING/APPROVED/REJECTED |
| is_hot | tinyint | NOT NULL | 是否热门 |
| created_at | datetime(3) | NOT NULL | 创建时间 |
| updated_at | datetime(3) | NOT NULL | 更新时间 |

索引：
- `idx_videos_uploader` / `idx_videos_created_at` / `idx_videos_audit_status` / `idx_videos_is_hot`

### video_stats

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| video_id | bigint unsigned | PK, FK(videos.id) | 视频ID |
| play_count | bigint unsigned | NOT NULL | 播放数 |
| like_count | bigint unsigned | NOT NULL | 点赞数 |
| comment_count | bigint unsigned | NOT NULL | 评论数 |
| favorite_count | bigint unsigned | NOT NULL | 收藏数 |
| hot_score | double | NOT NULL | 热度分（口径后续确定） |
| updated_at | datetime(3) | NOT NULL | 更新时间 |

### comments

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint unsigned | PK | 评论ID |
| video_id | bigint unsigned | FK(videos.id) | 视频ID |
| user_id | bigint unsigned | FK(users.id) | 用户ID |
| content | text | NOT NULL | 评论内容 |
| created_at | datetime(3) | NOT NULL | 创建时间 |

索引：
- `idx_comments_video_time` / `idx_comments_user_time`

### video_likes / video_favorites

共同字段：
- `id`（PK）, `video_id`（FK）, `user_id`（FK）, `created_at`

关键约束：
- `UNIQUE(video_id, user_id)`：避免重复点赞/收藏

### user_actions

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint unsigned | PK | 行为ID |
| user_id | bigint unsigned | FK(users.id) | 用户ID |
| video_id | bigint unsigned | FK(videos.id) | 视频ID |
| action_type | varchar(32) | NOT NULL | 行为类型（约定：PLAY/LIKE/COMMENT/FAVORITE 等） |
| action_time | datetime(3) | NOT NULL | 行为发生时间 |
| duration_ms | bigint unsigned | NULL | 播放时长（可选） |
| is_completed | tinyint | NULL | 是否完播（可选） |
| created_at | datetime(3) | NOT NULL | 记录创建时间 |

索引：
- `idx_user_actions_user_time` / `idx_user_actions_video_time` / `idx_user_actions_type_time`

### daily_metrics

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| day | date | PK | 自然日 |
| play_count | bigint unsigned | NOT NULL | 播放量 |
| like_count | bigint unsigned | NOT NULL | 点赞量 |
| comment_count | bigint unsigned | NOT NULL | 评论量 |
| favorite_count | bigint unsigned | NOT NULL | 收藏量 |
| active_user_count | bigint unsigned | NOT NULL | 活跃用户数 |
| new_user_count | bigint unsigned | NOT NULL | 新增用户数 |
| created_at | datetime(3) | NOT NULL | 创建时间 |
| updated_at | datetime(3) | NOT NULL | 更新时间 |

### email_verification_codes

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint unsigned | PK | 主键 |
| email | varchar(128) | NOT NULL | 邮箱 |
| code | varchar(16) | NOT NULL | 验证码 |
| purpose | varchar(32) | NOT NULL | 用途（REGISTER） |
| expires_at | datetime(3) | NOT NULL | 过期时间（5分钟） |
| used_at | datetime(3) | NULL | 使用时间（使用后置为非空） |
| created_at | datetime(3) | NOT NULL | 创建时间 |

索引：
- `idx_evc_email_purpose_created(email, purpose, created_at)`：查询最新验证码
- `idx_evc_expires_at(expires_at)`：清理过期数据（可选）
